USE [MSCRM_Stage]
GO

/****** Object:  StoredProcedure [mscrm].[usp_Accounts_Delta]    Script Date: 8/29/2015 10:42:56 AM ******/
DROP PROCEDURE [mscrm].[usp_Accounts_Delta]
GO

/****** Object:  StoredProcedure [mscrm].[usp_Accounts_Delta]    Script Date: 8/29/2015 10:42:56 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--ALTER TABLE [mscrm].[Accounts_Stage]
--TRUNCATE TABLE [mscrm].[Accounts_Delta]


CREATE PROCEDURE [mscrm].[usp_Accounts_Delta] --1
(@Job_Id AS INT)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@CurrentDtTm DATETIME = GETDATE()
	, @PreviousDtTm DATETIME = DATEADD(ms, -10, GETDATE())

	--Close records which are no longer populated or changed
		UPDATE  curr
		SET		EndDtTm = @PreviousDtTm,
				[Is_NewAccount]=0,
				[Is_UpdatedAccount]=0,
				[Is_DeletedAccount]=0
		FROM	[mscrm].[Accounts_Delta] curr
		LEFT JOIN [mscrm].[Accounts_Stage] new 
				ON curr.accountid = new.accountid
		WHERE	curr.EndDtTm = '9999-12-31'
				AND curr.HASHKEY <> new.HASHKEY;

	--Close off missing records
	Update curr
	SET EndDtTm = @PreviousDtTm,
		[Is_DeletedAccount]=1,
		[Is_NewAccount]=0,
		[Is_UpdatedAccount]=0,
		[Job_Id]=@Job_Id
	From [mscrm].[Accounts_Delta] curr
	LEFT JOIN [mscrm].[Accounts_Stage] ll
	ON curr.accountid = ll.accountid
	Where ll.accountid IS NULL
	AND curr.EndDtTm = '99991231'


	--Insert new or refreshed records
	print 'insert'
	INSERT INTO [mscrm].[Accounts_Delta]
	(
		EffectiveDtTm
		, EndDtTm
		,accountid
		 ,[Job_Id]
      ,[accountnumber]
      ,[accountcategorycode]
      ,[accountcategorycodename]
      ,[accountclassificationcode]
      ,[accountclassificationcodename]
      ,[accountratingcode]
      ,[accountratingcodename]
      ,[address1_addressid]
      ,[address1_addresstypecode]
      ,[address1_addresstypecodename]
      ,[address1_city]
      ,[address1_composite]
      ,[address1_country]
      ,[address1_county]
      ,[address1_fax]
      ,[address1_freighttermscode]
      ,[address1_freighttermscodename]
      ,[address1_latitude]
      ,[address1_line1]
      ,[address1_line2]
      ,[address1_line3]
      ,[address1_longitude]
      ,[address1_name]
      ,[address1_postalcode]
      ,[address1_postofficebox]
      ,[address1_primarycontactname]
      ,[address1_shippingmethodcode]
      ,[address1_shippingmethodcodename]
      ,[address1_stateorprovince]
      ,[address1_telephone1]
      ,[address1_telephone2]
      ,[address1_telephone3]
      ,[address1_upszone]
      ,[address1_utcoffset]
      ,[address2_addressid]
      ,[address2_addresstypecode]
      ,[address2_addresstypecodename]
      ,[address2_city]
      ,[address2_composite]
      ,[address2_country]
      ,[address2_county]
      ,[address2_fax]
      ,[address2_freighttermscode]
      ,[address2_freighttermscodename]
      ,[address2_latitude]
      ,[address2_line1]
      ,[address2_line2]
      ,[address2_line3]
      ,[address2_longitude]
      ,[address2_name]
      ,[address2_postalcode]
      ,[address2_postofficebox]
      ,[address2_primarycontactname]
      ,[address2_shippingmethodcode]
      ,[address2_shippingmethodcodename]
      ,[address2_stateorprovince]
      ,[address2_telephone1]
      ,[address2_telephone2]
      ,[address2_telephone3]
      ,[address2_upszone]
      ,[address2_utcoffset]
      ,[aging30]
      ,[aging30_base]
      ,[aging60]
      ,[aging60_base]
      ,[aging90]
      ,[aging90_base]
      ,[businesstypecode]
      ,[businesstypecodename]
      ,[createdby]
      ,[createdbyname]
      ,[createdbyyominame]
      ,[createdon]
      ,[createdonbehalfby]
      ,[createdonbehalfbyname]
      ,[createdonbehalfbyyominame]
      ,[creditlimit]
      ,[creditlimit_base]
      ,[creditonhold]
      ,[creditonholdname]
      ,[customersizecode]
      ,[customersizecodename]
      ,[customertypecode]
      ,[customertypecodename]
      ,[defaultpricelevelid]
      ,[defaultpricelevelidname]
      ,[description]
      ,[donotbulkemail]
      ,[donotbulkemailname]
      ,[donotbulkpostalmail]
      ,[donotbulkpostalmailname]
      ,[donotemail]
      ,[donotemailname]
      ,[donotfax]
      ,[donotfaxname]
      ,[donotphone]
      ,[donotphonename]
      ,[donotpostalmail]
      ,[donotpostalmailname]
      ,[donotsendmarketingmaterialname]
      ,[donotsendmm]
      ,[emailaddress1]
      ,[emailaddress2]
      ,[emailaddress3]
      ,[entityimage]
      ,[entityimage_timestamp]
      ,[entityimage_url]
      ,[entityimageid]
      ,[exchangerate]
      ,[fax]
      ,[ftpsiteurl]
      ,[importsequencenumber]
      ,[industrycode]
      ,[industrycodename]
      ,[isprivatename]
      ,[lastusedincampaign]
      ,[marketcap]
      ,[marketcap_base]
      ,[masteraccountidname]
      ,[masteraccountidyominame]
      ,[masterid]
      ,[merged]
      ,[mergedname]
      ,[modifiedby]
      ,[modifiedbyname]
      ,[modifiedbyyominame]
      ,[modifiedon]
      ,[modifiedonbehalfby]
      ,[modifiedonbehalfbyname]
      ,[modifiedonbehalfbyyominame]
      ,[name]
      ,[numberofemployees]
      ,[opendeals]
      ,[opendeals_date]
      ,[opendeals_state]
      ,[openrevenue]
      ,[openrevenue_base]
      ,[openrevenue_date]
      ,[openrevenue_state]
      ,[originatingleadid]
      ,[originatingleadidname]
      ,[originatingleadidyominame]
      ,[overriddencreatedon]
      ,[ownerid]
      ,[owneridname]
      ,[owneridtype]
      ,[owneridyominame]
      ,[ownershipcode]
      ,[ownershipcodename]
      ,[owningbusinessunit]
      ,[owningteam]
      ,[owninguser]
      ,[painc_accountobjective]
      ,[painc_accountobjectivename]
      ,[painc_ach]
      ,[painc_achbankname]
      ,[painc_achname]
      ,[painc_axyscode]
      ,[painc_billingon]
      ,[painc_billingonname]
      --,[painc_brokerageaccountnumber]
      ,[painc_checkingprivledges]
      ,[painc_checkingprivledgesname]
      ,[painc_closedate]
      ,[painc_custodian]
      ,[painc_custodianname]
      ,[painc_econfirm]
      ,[painc_econfirmname]
      ,[painc_feemethod]
      ,[painc_feemethodname]
      ,[painc_feetier1iar]
      ,[painc_feetier1probity]
      ,[painc_feetier1total]
      ,[painc_feetier2iar]
      ,[painc_feetier2probity]
      ,[painc_feetier2total]
      ,[painc_feetier3iar]
      ,[painc_feetier3probity]
      ,[painc_feetier3total]
      ,[painc_feetier4iar]
      ,[painc_feetier4probity]
      ,[painc_feetier4total]
      ,[painc_feetier5iar]
      ,[painc_feetier5probity]
      ,[painc_feetier5total]
      ,[painc_feetier6iar]
      ,[painc_feetier6probity]
      ,[painc_feetier6total]
      ,[painc_initialsize]
      ,[painc_initialsize_base]
      ,[painc_investmentplatform]
      ,[painc_investmentplatformname]
      ,[painc_margin]
      ,[painc_marginaltaxrate]
      ,[painc_marginname]
      ,[painc_mincash]
      ,[painc_mincash_base]
      ,[painc_mincashpercentage]
      ,[painc_nickname]
      ,[painc_officecode]
      ,[painc_officecodename]
      ,[painc_options]
      ,[painc_optionsname]
      ,[painc_probityaccountnumber]
      ,[painc_profilenotes]
      ,[painc_riskprofile]
      ,[painc_riskprofilename]
      ,[painc_startdate]
      ,[painc_taxdeferred]
      ,[painc_taxdeferredname]
      ,[painc_taxidentificationnumber1]
      ,[painc_taxidentificationnumber2]
      ,[painc_taxqualified]
      ,[painc_taxqualifiedname]
      ,[painc_wsaaccount]
      ,[painc_wsaaccountname]
      ,[parentaccountid]
      ,[parentaccountidname]
      ,[parentaccountidyominame]
      ,[participatesinworkflow]
      ,[participatesinworkflowname]
      ,[paymenttermscode]
      ,[paymenttermscodename]
      ,[preferredappointmentdaycode]
      ,[preferredappointmentdaycodename]
      ,[preferredappointmenttimecode]
      ,[preferredappointmenttimecodename]
      ,[preferredcontactmethodcode]
      ,[preferredcontactmethodcodename]
      ,[preferredequipmentid]
      ,[preferredequipmentidname]
      ,[preferredserviceid]
      ,[preferredserviceidname]
      ,[preferredsystemuserid]
      ,[preferredsystemuseridname]
      ,[preferredsystemuseridyominame]
      ,[primarycontactid]
      ,[primarycontactidname]
      ,[primarycontactidyominame]
      ,[processid]
      ,[revenue]
      ,[revenue_base]
      ,[sharesoutstanding]
      ,[shippingmethodcode]
      ,[shippingmethodcodename]
      ,[sic]
      ,[stageid]
      ,[statecode]
      ,[statecodename]
      ,[statuscode]
      ,[statuscodename]
      ,[stockexchange]
      ,[telephone1]
      ,[telephone2]
      ,[telephone3]
      ,[territorycode]
      ,[territorycodename]
      ,[territoryid]
      ,[territoryidname]
      ,[tickersymbol]
      ,[timezoneruleversionnumber]
      ,[transactioncurrencyid]
      ,[transactioncurrencyidname]
      ,[traversedpath]
      ,[utcconversiontimezonecode]
      ,[versionnumber]
      ,[websiteurl]
      ,[yominame]
	  ,[painc_abortifacients]
      ,[painc_abortifacientsname]
      ,[painc_adultentertainment]
      ,[painc_adultentertainmentname]
      ,[painc_adultentertainmentproducers]
      ,[painc_adultentertainmentproducersname]
      ,[painc_adultentertainmentproviders]
      ,[painc_adultentertainmentprovidersname]
      ,[painc_alcohol]
      ,[painc_alcoholname]
      ,[painc_animalwelfare]
      ,[painc_animalwelfarename]
      ,[painc_childsweatshoplabor]
      ,[painc_childsweatshoplaborname]
      ,[painc_civilianfirearmsproducer]
      ,[painc_civilianfirearmsproducername]
      ,[painc_consumerproductsafety]
      ,[painc_consumerproductsafetyname]
      ,[painc_contraceptiveandabortifacientproducts]
      ,[painc_contraceptiveandabortifacientproductsname]
      ,[painc_contraceptives]
      ,[painc_contraceptivesname]
      ,[painc_crmaccounttype]
      ,[painc_crmaccounttypename]
      ,[painc_custodianaccountnumber]
      ,[painc_custodianaccounttype]
      ,[painc_custodianaccounttypename]
      ,[painc_defenseandweapons]
      ,[painc_defenseandweaponsname]
      ,[painc_environmentemissions]
      ,[painc_environmentemissionsname]
      ,[painc_environmentfederallaws]
      ,[painc_environmentfederallawsname]
      ,[painc_environmentspillsreleases]
      ,[painc_environmentspillsreleasesname]
      ,[painc_fairlending]
      ,[painc_fairlendingname]
      ,[painc_gambling]
      ,[painc_gamblingname]
      ,[painc_geneticallymodifiedorganisms]
      ,[painc_geneticallymodifiedorganismsname]
      ,[painc_humanrights]
      ,[painc_humanrightsname]
      ,[painc_laborrelationsdiversity]
      ,[painc_laborrelationsdiversityname]
      ,[painc_laborrelationsissuescontroversy]
      ,[painc_laborrelationsissuescontroversyname]
      ,[painc_laborrelationsosha]
      ,[painc_laborrelationsoshaname]
      ,[painc_mailingtopline]
      ,[painc_nuclearpower]
      ,[painc_nuclearpowername]
      ,[painc_salutationline]
      ,[painc_stemcellresearch]
      ,[painc_stemcellresearchname]
      ,[painc_tobacco]
      ,[painc_tobacconame]
      ,[painc_weapons]
      ,[painc_weaponsname]
	  ,[painc_healthcarename]
      ,[hashkey]
      ,[Is_NewAccount]
      ,[Is_UpdatedAccount]
      ,[Is_DeletedAccount]
		
	)
	SELECT	@CurrentDtTm AS EffectiveDtTm
		, '9999-12-31' AS EndDtTm 
		,new.accountid
      ,new.[Job_Id]
      ,new.[accountnumber]
      ,new.[accountcategorycode]
      ,new.[accountcategorycodename]
      ,new.[accountclassificationcode]
      ,new.[accountclassificationcodename]
      ,new.[accountratingcode]
      ,new.[accountratingcodename]
      ,new.[address1_addressid]
      ,new.[address1_addresstypecode]
      ,new.[address1_addresstypecodename]
      ,new.[address1_city]
      ,new.[address1_composite]
      ,new.[address1_country]
      ,new.[address1_county]
      ,new.[address1_fax]
      ,new.[address1_freighttermscode]
      ,new.[address1_freighttermscodename]
      ,new.[address1_latitude]
      ,new.[address1_line1]
      ,new.[address1_line2]
      ,new.[address1_line3]
      ,new.[address1_longitude]
      ,new.[address1_name]
      ,new.[address1_postalcode]
      ,new.[address1_postofficebox]
      ,new.[address1_primarycontactname]
      ,new.[address1_shippingmethodcode]
      ,new.[address1_shippingmethodcodename]
      ,new.[address1_stateorprovince]
      ,new.[address1_telephone1]
      ,new.[address1_telephone2]
      ,new.[address1_telephone3]
      ,new.[address1_upszone]
      ,new.[address1_utcoffset]
      ,new.[address2_addressid]
      ,new.[address2_addresstypecode]
      ,new.[address2_addresstypecodename]
      ,new.[address2_city]
      ,new.[address2_composite]
      ,new.[address2_country]
      ,new.[address2_county]
      ,new.[address2_fax]
      ,new.[address2_freighttermscode]
      ,new.[address2_freighttermscodename]
      ,new.[address2_latitude]
      ,new.[address2_line1]
      ,new.[address2_line2]
      ,new.[address2_line3]
      ,new.[address2_longitude]
      ,new.[address2_name]
      ,new.[address2_postalcode]
      ,new.[address2_postofficebox]
      ,new.[address2_primarycontactname]
      ,new.[address2_shippingmethodcode]
      ,new.[address2_shippingmethodcodename]
      ,new.[address2_stateorprovince]
      ,new.[address2_telephone1]
      ,new.[address2_telephone2]
      ,new.[address2_telephone3]
      ,new.[address2_upszone]
      ,new.[address2_utcoffset]
      ,new.[aging30]
      ,new.[aging30_base]
      ,new.[aging60]
      ,new.[aging60_base]
      ,new.[aging90]
      ,new.[aging90_base]
      ,new.[businesstypecode]
      ,new.[businesstypecodename]
      ,new.[createdby]
      ,new.[createdbyname]
      ,new.[createdbyyominame]
      ,new.[createdon]
      ,new.[createdonbehalfby]
      ,new.[createdonbehalfbyname]
      ,new.[createdonbehalfbyyominame]
      ,new.[creditlimit]
      ,new.[creditlimit_base]
      ,new.[creditonhold]
      ,new.[creditonholdname]
      ,new.[customersizecode]
      ,new.[customersizecodename]
      ,new.[customertypecode]
      ,new.[customertypecodename]
      ,new.[defaultpricelevelid]
      ,new.[defaultpricelevelidname]
      ,new.[description]
      ,new.[donotbulkemail]
      ,new.[donotbulkemailname]
      ,new.[donotbulkpostalmail]
      ,new.[donotbulkpostalmailname]
      ,new.[donotemail]
      ,new.[donotemailname]
      ,new.[donotfax]
      ,new.[donotfaxname]
      ,new.[donotphone]
      ,new.[donotphonename]
      ,new.[donotpostalmail]
      ,new.[donotpostalmailname]
      ,new.[donotsendmarketingmaterialname]
      ,new.[donotsendmm]
      ,new.[emailaddress1]
      ,new.[emailaddress2]
      ,new.[emailaddress3]
      ,new.[entityimage]
      ,new.[entityimage_timestamp]
      ,new.[entityimage_url]
      ,new.[entityimageid]
      ,new.[exchangerate]
      ,new.[fax]
      ,new.[ftpsiteurl]
      ,new.[importsequencenumber]
      ,new.[industrycode]
      ,new.[industrycodename]
      ,new.[isprivatename]
      ,new.[lastusedincampaign]
      ,new.[marketcap]
      ,new.[marketcap_base]
      ,new.[masteraccountidname]
      ,new.[masteraccountidyominame]
      ,new.[masterid]
      ,new.[merged]
      ,new.[mergedname]
      ,new.[modifiedby]
      ,new.[modifiedbyname]
      ,new.[modifiedbyyominame]
      ,new.[modifiedon]
      ,new.[modifiedonbehalfby]
      ,new.[modifiedonbehalfbyname]
      ,new.[modifiedonbehalfbyyominame]
      ,new.[name]
      ,new.[numberofemployees]
      ,new.[opendeals]
      ,new.[opendeals_date]
      ,new.[opendeals_state]
      ,new.[openrevenue]
      ,new.[openrevenue_base]
      ,new.[openrevenue_date]
      ,new.[openrevenue_state]
      ,new.[originatingleadid]
      ,new.[originatingleadidname]
      ,new.[originatingleadidyominame]
      ,new.[overriddencreatedon]
      ,new.[ownerid]
      ,new.[owneridname]
      ,new.[owneridtype]
      ,new.[owneridyominame]
      ,new.[ownershipcode]
      ,new.[ownershipcodename]
      ,new.[owningbusinessunit]
      ,new.[owningteam]
      ,new.[owninguser]
      ,new.[painc_accountobjective]
      ,new.[painc_accountobjectivename]
      ,new.[painc_ach]
      ,new.[painc_achbankname]
      ,new.[painc_achname]
      ,new.[painc_axyscode]
      ,new.[painc_billingon]
      ,new.[painc_billingonname]
     -- ,new.[painc_brokerageaccountnumber]
      ,new.[painc_checkingprivledges]
      ,new.[painc_checkingprivledgesname]
      ,new.[painc_closedate]
      ,new.[painc_custodian]
      ,new.[painc_custodianname]
      ,new.[painc_econfirm]
      ,new.[painc_econfirmname]
      ,new.[painc_feemethod]
      ,new.[painc_feemethodname]
      ,new.[painc_feetier1iar]
      ,new.[painc_feetier1probity]
      ,new.[painc_feetier1total]
      ,new.[painc_feetier2iar]
      ,new.[painc_feetier2probity]
      ,new.[painc_feetier2total]
      ,new.[painc_feetier3iar]
      ,new.[painc_feetier3probity]
      ,new.[painc_feetier3total]
      ,new.[painc_feetier4iar]
      ,new.[painc_feetier4probity]
      ,new.[painc_feetier4total]
      ,new.[painc_feetier5iar]
      ,new.[painc_feetier5probity]
      ,new.[painc_feetier5total]
      ,new.[painc_feetier6iar]
      ,new.[painc_feetier6probity]
      ,new.[painc_feetier6total]
      ,new.[painc_initialsize]
      ,new.[painc_initialsize_base]
      ,new.[painc_investmentplatform]
      ,new.[painc_investmentplatformname]
      ,new.[painc_margin]
      ,new.[painc_marginaltaxrate]
      ,new.[painc_marginname]
      ,new.[painc_mincash]
      ,new.[painc_mincash_base]
      ,new.[painc_mincashpercentage]
      ,new.[painc_nickname]
      ,new.[painc_officecode]
      ,new.[painc_officecodename]
      ,new.[painc_options]
      ,new.[painc_optionsname]
      ,new.[painc_probityaccountnumber]
      ,new.[painc_profilenotes]
      ,new.[painc_riskprofile]
      ,new.[painc_riskprofilename]
      ,new.[painc_startdate]
      ,new.[painc_taxdeferred]
      ,new.[painc_taxdeferredname]
      ,new.[painc_taxidentificationnumber1]
      ,new.[painc_taxidentificationnumber2]
      ,new.[painc_taxqualified]
      ,new.[painc_taxqualifiedname]
      ,new.[painc_wsaaccount]
      ,new.[painc_wsaaccountname]
      ,new.[parentaccountid]
      ,new.[parentaccountidname]
      ,new.[parentaccountidyominame]
      ,new.[participatesinworkflow]
      ,new.[participatesinworkflowname]
      ,new.[paymenttermscode]
      ,new.[paymenttermscodename]
      ,new.[preferredappointmentdaycode]
      ,new.[preferredappointmentdaycodename]
      ,new.[preferredappointmenttimecode]
      ,new.[preferredappointmenttimecodename]
      ,new.[preferredcontactmethodcode]
      ,new.[preferredcontactmethodcodename]
      ,new.[preferredequipmentid]
      ,new.[preferredequipmentidname]
      ,new.[preferredserviceid]
      ,new.[preferredserviceidname]
      ,new.[preferredsystemuserid]
      ,new.[preferredsystemuseridname]
      ,new.[preferredsystemuseridyominame]
      ,new.[primarycontactid]
      ,new.[primarycontactidname]
      ,new.[primarycontactidyominame]
      ,new.[processid]
      ,new.[revenue]
      ,new.[revenue_base]
      ,new.[sharesoutstanding]
      ,new.[shippingmethodcode]
      ,new.[shippingmethodcodename]
      ,new.[sic]
      ,new.[stageid]
      ,new.[statecode]
      ,new.[statecodename]
      ,new.[statuscode]
      ,new.[statuscodename]
      ,new.[stockexchange]
      ,new.[telephone1]
      ,new.[telephone2]
      ,new.[telephone3]
      ,new.[territorycode]
      ,new.[territorycodename]
      ,new.[territoryid]
      ,new.[territoryidname]
      ,new.[tickersymbol]
      ,new.[timezoneruleversionnumber]
      ,new.[transactioncurrencyid]
      ,new.[transactioncurrencyidname]
      ,new.[traversedpath]
      ,new.[utcconversiontimezonecode]
      ,new.[versionnumber]
      ,new.[websiteurl]
      ,new.[yominame]
	  ,new.[painc_abortifacients]
      ,new.[painc_abortifacientsname]
      ,new.[painc_adultentertainment]
      ,new.[painc_adultentertainmentname]
      ,new.[painc_adultentertainmentproducers]
      ,new.[painc_adultentertainmentproducersname]
      ,new.[painc_adultentertainmentproviders]
      ,new.[painc_adultentertainmentprovidersname]
      ,new.[painc_alcohol]
      ,new.[painc_alcoholname]
      ,new.[painc_animalwelfare]
      ,new.[painc_animalwelfarename]
      ,new.[painc_childsweatshoplabor]
      ,new.[painc_childsweatshoplaborname]
      ,new.[painc_civilianfirearmsproducer]
      ,new.[painc_civilianfirearmsproducername]
      ,new.[painc_consumerproductsafety]
      ,new.[painc_consumerproductsafetyname]
      ,new.[painc_contraceptiveandabortifacientproducts]
      ,new.[painc_contraceptiveandabortifacientproductsname]
      ,new.[painc_contraceptives]
      ,new.[painc_contraceptivesname]
      ,new.[painc_crmaccounttype]
      ,new.[painc_crmaccounttypename]
      ,new.[painc_custodianaccountnumber]
      ,new.[painc_custodianaccounttype]
      ,new.[painc_custodianaccounttypename]
      ,new.[painc_defenseandweapons]
      ,new.[painc_defenseandweaponsname]
      ,new.[painc_environmentemissions]
      ,new.[painc_environmentemissionsname]
      ,new.[painc_environmentfederallaws]
      ,new.[painc_environmentfederallawsname]
      ,new.[painc_environmentspillsreleases]
      ,new.[painc_environmentspillsreleasesname]
      ,new.[painc_fairlending]
      ,new.[painc_fairlendingname]
      ,new.[painc_gambling]
      ,new.[painc_gamblingname]
      ,new.[painc_geneticallymodifiedorganisms]
      ,new.[painc_geneticallymodifiedorganismsname]
      ,new.[painc_humanrights]
      ,new.[painc_humanrightsname]
      ,new.[painc_laborrelationsdiversity]
      ,new.[painc_laborrelationsdiversityname]
      ,new.[painc_laborrelationsissuescontroversy]
      ,new.[painc_laborrelationsissuescontroversyname]
      ,new.[painc_laborrelationsosha]
      ,new.[painc_laborrelationsoshaname]
      ,new.[painc_mailingtopline]
      ,new.[painc_nuclearpower]
      ,new.[painc_nuclearpowername]
      ,new.[painc_salutationline]
      ,new.[painc_stemcellresearch]
      ,new.[painc_stemcellresearchname]
      ,new.[painc_tobacco]
      ,new.[painc_tobacconame]
      ,new.[painc_weapons]
      ,new.[painc_weaponsname]
	  ,new.[painc_healthcarename]
      ,new.[hashkey]
      ,new.[Is_NewAccount]
      ,NULL--,CASE WHEN new.[Is_NewAccount]=0 THEN 1 ELSE 0 END [Is_UpdatedAccount]
      ,new.[Is_DeletedAccount]
    FROM [mscrm].[Accounts_Stage] new
	LEFT JOIN [mscrm].[Accounts_Delta] curr
		ON curr.accountid = new.accountid
		AND curr.HASHKEY = new.HASHKEY
		AND curr.EndDtTm = '9999-12-31'
	WHERE curr.accountid IS NULL;
	print 'update'
	UPDATE [mscrm].[Accounts_Delta]
	SET Is_UpdatedAccount=CASE WHEN [Is_NewAccount]=0 THEN 1 ELSE 0 END
	WHERE [Job_Id]=@Job_Id;
END





GO


